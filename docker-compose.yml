# Code-Vibes RFC + Planka Integration
# Full stack deployment for RFC workflow management
#
# IMPORTANT: Copy .env.example to .env and configure secrets before starting!

services:
  # ==================== CODE-VIBES SERVICES ====================
  
  code-vibes-backend:
    build:
      context: ./code-vibes/backend/rfc-service
      dockerfile: Dockerfile
    restart: on-failure
    ports:
      - "8080:8080"
    environment:
      # Spring Profile
      - SPRING_PROFILES_ACTIVE=docker
      
      # Database
      - SPRING_DATASOURCE_URL=jdbc:postgresql://code-vibes-db:5432/cab_db
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:-postgres}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD}

      # Keycloak
      # Use JWK Set URI directly to avoid issuer discovery issues
      # issuer-uri must match the issuer in JWT tokens from browser login
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI=http://localhost:8081/realms/cab-realm
      - SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI=http://keycloak:8080/realms/cab-realm/protocol/openid-connect/certs
      - KEYCLOAK_AUTH_SERVER_URL=http://keycloak:8080

      # Security
      - APP_SECURITY_ENABLED=${APP_SECURITY_ENABLED:-true}

      # Planka Integration
      - PLANKA_ENABLED=${PLANKA_ENABLED:-true}
      - PLANKA_URL=http://planka:1337
      - PLANKA_API_TOKEN=${PLANKA_API_TOKEN}
      - PLANKA_WEBHOOK_SECRET=${PLANKA_WEBHOOK_SECRET}
      - PLANKA_PROJECT_ID=${PLANKA_PROJECT_ID}
      - PLANKA_BOARD_ID=${PLANKA_BOARD_ID}
      - PLANKA_AUTO_SYNC=${PLANKA_AUTO_SYNC:-true}
      - PLANKA_USER_SYNC=${PLANKA_USER_SYNC:-true}
    extra_hosts:
      # Allow backend to reach localhost:8081 (Keycloak) from inside container
      - "localhost:host-gateway"
    depends_on:
      code-vibes-db:
        condition: service_healthy
      keycloak:
        condition: service_started
    networks:
      - code-vibes-net
      - integration-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  code-vibes-frontend:
    build:
      context: ./code-vibes/frontend
      dockerfile: Dockerfile
    restart: on-failure
    ports:
      - "5173:80"
    environment:
      - VITE_API_URL=/api
      - VITE_KEYCLOAK_URL=http://localhost:8081
      - VITE_KEYCLOAK_REALM=cab-realm
      - VITE_KEYCLOAK_CLIENT_ID=cab-frontend
    depends_on:
      - code-vibes-backend
      - keycloak
    networks:
      - code-vibes-net

  code-vibes-db:
    image: postgres:16-alpine
    restart: on-failure
    volumes:
      - code-vibes-db-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=cab_db
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d cab_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - code-vibes-net

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.0
    restart: on-failure
    command: start-dev --import-realm
    ports:
      - "8081:8080"
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KC_HEALTH_ENABLED=true
      # Fixed hostname for browser access - Keycloak will always return localhost:8081 URLs
      - KC_HOSTNAME=localhost
      - KC_HOSTNAME_PORT=8081
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
    volumes:
      - ./code-vibes/deploy/keycloak:/opt/keycloak/data/import:ro
    networks:
      - code-vibes-net
      - integration-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==================== PLANKA SERVICES ====================
  
  planka:
    build:
      context: ./planka
      dockerfile: Dockerfile
    restart: on-failure
    ports:
      - "3000:1337"
    volumes:
      - planka-favicons:/app/public/favicons
      - planka-user-avatars:/app/public/user-avatars
      - planka-background-images:/app/public/background-images
      - planka-attachments:/app/private/attachments
    environment:
      - BASE_URL=${PLANKA_BASE_URL:-http://localhost:3000}
      - DATABASE_URL=postgresql://postgres@planka-db/planka
      - SECRET_KEY=${PLANKA_SECRET_KEY}
      - LOG_LEVEL=${PLANKA_LOG_LEVEL:-info}

      # RFC Integration
      - RFC_ENABLED=${RFC_ENABLED:-true}
      - RFC_WEBHOOKS_ENABLED=${RFC_WEBHOOKS_ENABLED:-true}
      - RFC_WEBHOOK_URL=http://code-vibes-backend:8080/api/webhook/planka
      - RFC_WEBHOOK_SECRET=${PLANKA_WEBHOOK_SECRET}
      - RFC_BOARD_ID=${PLANKA_BOARD_ID}

      # OIDC/Keycloak SSO Integration
      # Use localhost:8081 for browser URLs, internal network uses host.docker.internal
      - OIDC_ISSUER=http://localhost:8081/realms/cab-realm
      - OIDC_CLIENT_ID=planka
      - OIDC_CLIENT_SECRET=planka-client-secret-123
      - OIDC_SCOPES=openid email profile
      - OIDC_CLAIMS_SOURCE=userinfo
      - OIDC_EMAIL_ATTRIBUTE=email
      - OIDC_NAME_ATTRIBUTE=name
      - OIDC_USERNAME_ATTRIBUTE=preferred_username
      - OIDC_ROLES_ATTRIBUTE=groups
      # Role mapping: Keycloak roles -> Planka roles
      - OIDC_ADMIN_ROLES=ADMIN
      - OIDC_PROJECT_OWNER_ROLES=CAB_MANAGER,RFC_APPROVER
      - OIDC_BOARD_USER_ROLES=USER
      - OIDC_ENFORCED=${OIDC_ENFORCED:-false}

      # Default admin (fallback when OIDC is not enforced)
      # Use admin_local to avoid conflict with Keycloak admin user
      - DEFAULT_ADMIN_EMAIL=${PLANKA_ADMIN_EMAIL:-admin_local@example.com}
      - DEFAULT_ADMIN_PASSWORD=${PLANKA_ADMIN_PASSWORD}
      - DEFAULT_ADMIN_NAME=${PLANKA_ADMIN_NAME:-Admin Local}
      - DEFAULT_ADMIN_USERNAME=${PLANKA_ADMIN_USERNAME:-admin_local}
    extra_hosts:
      # Allow Planka to reach localhost:8081 (Keycloak) from inside container
      - "localhost:host-gateway"
    depends_on:
      planka-db:
        condition: service_healthy
      keycloak:
        condition: service_started
    networks:
      - planka-net
      - integration-net
      - code-vibes-net

  planka-db:
    image: postgres:16-alpine
    restart: on-failure
    volumes:
      - planka-db-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=planka
      - POSTGRES_HOST_AUTH_METHOD=trust
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d planka"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - planka-net

volumes:
  code-vibes-db-data:
  planka-db-data:
  planka-favicons:
  planka-user-avatars:
  planka-background-images:
  planka-attachments:

networks:
  code-vibes-net:
    driver: bridge
  planka-net:
    driver: bridge
  integration-net:
    driver: bridge
